<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>College Quiz — Projector Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --royal-blue:#0b3d91;
  --royal-blue-dark:#072a65;
  --gold:#ffd166;
  --text:#0b1b2b;
  --wrong:#d32f2f;
  --correct:#2e7d32;
  --panel:#ffffff;
  --bg:#f3f7ff;
  --pass-orange:#ff7f11;
  --question-num-color:#ffdd57;
}

/* Reset & base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* Header with centered logos and editable title */
.header {
  text-align:center;
  padding:10px 16px;
  background:#fff;
  border-bottom:4px solid var(--royal-blue);
}
.logo-row {
  display:inline-flex;
  align-items:center;
  gap:28px;
  justify-content:center;
  margin-bottom:8px;
}
.logo {
  height:90px; /* equal heights */
  width:auto;
  object-fit:contain;
}
.title-edit {
  display:block;
  margin: 6px auto;
  font-size:22px;
  font-weight:800;
  color:var(--royal-blue);
  background: transparent;
  border: 2px solid transparent;
  text-align:center;
  padding:6px 12px;
  border-radius:8px;
  min-width: 280px;
}
.title-edit[contenteditable="true"]:focus{
  outline: 2px dashed #c9d7ff;
}
.brand-small { font-size:13px; color:#666; margin-top:4px }

/* Layout */
.layout{
  display:flex;
  gap:16px;
  padding:16px;
}
.quiz-panel{
  flex:1 1 70%;
  background:var(--panel);
  border:2px solid var(--royal-blue);
  border-radius:12px;
  padding:16px;
  box-shadow:0 4px 14px rgba(0,0,0,0.06);
}
.scoreboard{
  flex:0 0 28%;
  background:#fffdf6;
  border:2px solid var(--royal-blue);
  border-radius:12px;
  padding:16px;
  box-shadow:0 4px 14px rgba(0,0,0,0.06);
}

/* Controls / Timer */
.controls{
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:8px;
  flex-wrap:wrap;
}
.timer-label input{
  width:90px;
  padding:6px 8px;
  font-size:16px;
}
.timer{
  font-weight:700;
  font-size:20px;
}
.timer.red{ color:#d32f2f; animation: pulse 1s infinite; }
.timer.orange{ color:var(--pass-orange); animation: pulse 1s infinite; }
@keyframes pulse{ 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }

/* Current team (big center display) */
.current-team{ font-weight:900; margin:10px 0; font-size:22px; text-align:center; }
.current-team .name{
  background:var(--gold);
  padding:6px 12px;
  border-radius:8px;
  font-size:22px;
  display:inline-block;
}

/* Question band */
.question-band{
  background:var(--royal-blue);
  border:2px solid var(--royal-blue-dark);
  border-radius:12px;
  padding:16px;
  margin-bottom:12px;
  display:flex;
  gap:16px;
  align-items:center;
  flex-wrap:wrap;
}
.question-num {
  color:var(--question-num-color);
  font-weight:900;
  font-size:20px;
  padding:6px 10px;
  border-radius:6px;
  background: rgba(0,0,0,0.08);
}
.question-text{
  color:#fff;
  font-weight:800;
  font-size:28px;
  line-height:1.3;
}

/* Options grid */
.options{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:8px;
}
.option{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  min-height:64px;
  border:2px solid var(--royal-blue);
  border-radius:10px;
  background:#fff;
  font-size:18px;
  font-weight:600;
  cursor:pointer;
  padding:10px;
  transition:transform .05s ease, background .2s ease, border-color .2s ease;
}
.option:hover{ background:#e8f1ff }
.option:disabled{ opacity:.6; cursor:not-allowed }

.option.correct{
  background:var(--correct);
  color:#fff;
  border-color:#1b5e20;
}
.option.wrong{
  background:var(--wrong);
  color:#fff;
  border-color:#b71c1c;
}

/* Image options */
.option img{
  max-height:110px;
  max-width:100%;
  object-fit:contain;
  border-radius:6px;
  display:block;
}

/* Buttons */
.action-row{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}
.btn{
  border:2px solid var(--royal-blue);
  background:#e8f1ff;
  color:#012150;
  padding:10px 14px;
  font-weight:700;
  border-radius:10px;
  cursor:pointer;
  min-width:180px;
}
.btn:disabled{ opacity:.5; cursor:not-allowed; }
.btn.primary{ background:var(--gold); border-color:#caa245; }

/* Scoreboard list */
.team{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 8px;
  border:1px solid #e6d49a;
  border-radius:8px;
  margin-bottom:8px;
  background:#fff8e1;
}
.team.active{ outline:3px solid var(--gold); }
.team input[type="text"]{
  flex:1;
  padding:6px 8px;
  font-size:14px;
  border:1px solid #c9b46b;
  border-radius:6px;
  background:#fffceb;
}
.score{
  width:70px;
  text-align:center;
  font-weight:800;
  background:#fffbea;
  border:1px solid #e1cf8a;
  border-radius:6px;
  padding:4px 0;
}
.team .smallbtn{
  padding:4px 8px;
  border:1px solid var(--royal-blue);
  border-radius:6px;
  background:#eef5ff;
  cursor:pointer;
}

/* Volume control */
.volume-row{ display:flex; gap:8px; align-items:center; margin-left:8px; }

/* Full-screen red flash overlay */
.timeout-overlay{
  position:fixed;
  inset:0;
  background:rgba(211,47,47,0.35);
  z-index:9999;
  animation:flash .65s infinite;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
@keyframes flash{ 0%{opacity:.25} 50%{opacity:.6} 100%{opacity:.25} }

/* Responsive */
@media (max-width: 1000px){
  .layout{flex-direction:column}
  .scoreboard{flex-basis:auto}
  .options{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <!-- Full-screen red flash when time hits 0 -->
  <div id="timeout-overlay" class="timeout-overlay" hidden>
    <div style="font-size:28px; color:white; font-weight:900">TIME'S UP</div>
  </div>

  <!-- Header: centered logos + editable title -->
  <header class="header">
    <div class="logo-row" aria-hidden="true">
      <img id="logoLeft" class="logo" alt="Logo 1" />
      <img id="logoRight" class="logo" alt="Logo 2" />
    </div>

    <div contenteditable="true" id="quizTitle" class="title-edit" role="textbox" aria-label="Quiz title">Inter-College Quiz 2025</div>
    <div class="brand-small">(Click the title to edit it)</div>
  </header>

  <main class="layout">
    <!-- Quiz panel -->
    <section class="quiz-panel">
      <div class="controls">
        <label class="timer-label">
          Main Timer (sec):
          <input type="number" id="timerInput" min="5" value="30" />
        </label>

        <div class="timer">Time Left: <span id="time">30</span>s</div>

        <div class="volume-row">
          Volume:
          <input id="volumeSlider" type="range" min="0" max="1" step="0.05" value="0.5" />
        </div>
      </div>

      <div id="currentTeamBig" class="current-team"><span class="name">Team A</span></div>

      <!-- Royal blue question band -->
      <div class="question-band">
        <div class="question-num" id="questionNum">Q1</div>
        <div id="question" class="question-text">Loading question…</div>
      </div>

      <!-- Options -->
      <div id="options" class="options" aria-live="polite"></div>

      <div class="action-row">
        <button id="showAnswerBtn" class="btn" disabled>Show Correct Answer</button>
        <button id="nextBtn" class="btn primary" disabled>Next Question</button>
      </div>
    </section>

    <!-- Scoreboard -->
    <aside class="scoreboard">
      <h2>Leaderboard (editable)</h2>
      <div id="teams"></div>
    </aside>
  </main>

<script>
/********** CONFIG **********/
/* Put your published CSV URL here (Google Sheet → Publish → CSV) */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRiqqInQm40Eo-MOFDuPOC40etCZdH3Fxnb5ZrZwJk2ziHeIVGOYyQ0xqWKNsL-vw1FxEfYzr7u18fZ/pub?output=csv";

/* Direct-view logos from your Drive (converted earlier) — replace if needed */
const LOGO_LEFT  = "https://drive.google.com/uc?export=view&id=1QCjEZ7XRiElI9pBeyCxtfnFLh_xuB4iS";
const LOGO_RIGHT = "https://drive.google.com/uc?export=view&id=1xKpU5akmap9vLgxtVyL0HMX1bsKUQdFl";

/* Scoring by pass number: 0th=4, 1st=3, 2nd=2, 3rd=1 */
const PASS_POINTS = [4,3,2,1];
const PASS_SECONDS = 5; // fixed pass timer
/****************************/

/* ------- DOM refs ------- */
document.getElementById("logoLeft").src = LOGO_LEFT;
document.getElementById("logoRight").src = LOGO_RIGHT;

const timerInput = document.getElementById("timerInput");
const timeEl = document.getElementById("time");
const timerBox = document.querySelector(".timer");
const overlay = document.getElementById("timeout-overlay");

const currentTeamBig = document.getElementById("currentTeamBig");
const qText = document.getElementById("question");
const qNumEl = document.getElementById("questionNum");
const optionsWrap = document.getElementById("options");
const showAnswerBtn = document.getElementById("showAnswerBtn");
const nextBtn = document.getElementById("nextBtn");
const teamsWrap = document.getElementById("teams");
const titleEl = document.getElementById("quizTitle");
const volumeSlider = document.getElementById("volumeSlider");

/* ------- State ------- */
let questions = []; // { question, options:[4], answerIndex }
let qIndex = 0;

let teams = [
  { name:"Team A", score:0 },
  { name:"Team B", score:0 },
  { name:"Team C", score:0 },
  { name:"Team D", score:0 },
];

let startTeamIndex = 0; // rotates starting team per question
let currentTeam = 0;    // whose turn it is now
let passCount = 0;      // 0 = direct, 1 = first pass, etc.

let timerId = null;
let timeLeft = 30;
let isPassTurn = false;

let clickedSet = new Set();
let correctIndex = -1;
let questionCompleted = false;

/* ------- Audio (WebAudio synthesized beeps) ------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let masterGain = audioCtx.createGain();
masterGain.gain.value = Number(volumeSlider.value);
masterGain.connect(audioCtx.destination);

volumeSlider.addEventListener('input', ()=>{ masterGain.gain.value = Number(volumeSlider.value); });

// play a short beep
function playBeep(freq=880, duration=0.12, type='sine'){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = 0.001;
    o.connect(g);
    g.connect(masterGain);
    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0.001, now);
    g.gain.exponentialRampToValueAtTime(0.5, now + 0.01);
    o.start(now);
    g.gain.exponentialRampToValueAtTime(0.001, now + duration);
    o.stop(now + duration + 0.02);
  }catch(e){ console.warn("Audio failed", e); }
}

// play buzzer (longer)
function playBuzzer(){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sawtooth';
    o.frequency.value = 220;
    o.connect(g);
    g.connect(masterGain);
    const now = audioCtx.currentTime;
    g.gain.setValueAtTime(0.001, now);
    g.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
    o.start(now);
    g.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
    o.frequency.setValueAtTime(220, now);
    o.frequency.exponentialRampToValueAtTime(80, now + 0.9);
    o.stop(now + 1.0);
  }catch(e){ console.warn("Audio failed", e); }
}

/* ------- Utils ------- */
function csvToRows(csvText){
  const rows = [];
  let row = [], cell = "", inQuotes = false;
  for (let i=0;i<csvText.length;i++){
    const c = csvText[i];
    if (c === '"'){
      if (inQuotes && csvText[i+1] === '"'){ cell += '"'; i++; }
      else inQuotes = !inQuotes;
    }else if (c === ',' && !inQuotes){
      row.push(cell); cell = "";
    }else if ((c === '\n' || c === '\r') && !inQuotes){
      if (c === '\r' && csvText[i+1] === '\n'){ continue; }
      row.push(cell); rows.push(row);
      row = []; cell = "";
    }else{
      cell += c;
    }
  }
  if (cell.length || row.length){ row.push(cell); rows.push(row); }
  return rows;
}
function isImageUrl(s){
  if (!s) return false;
  const lower = s.trim().toLowerCase();
  if (lower.startsWith("img:")) return true;
  return /^https?:\/\/.+\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(lower);
}

/* ------- Leaderboard ------- */
function renderTeams(){
  teamsWrap.innerHTML = "";
  teams.forEach((t, idx)=>{
    const row = document.createElement("div");
    row.className = "team" + (idx===currentTeam ? " active" : "");
    row.innerHTML = `
      <input type="text" value="${t.name}" />
      <span class="score" contenteditable="true">${t.score}</span>
      <button class="smallbtn" data-i="${idx}" data-delta="1">+1</button>
      <button class="smallbtn" data-i="${idx}" data-delta="-1">-1</button>
      <button class="smallbtn" data-i="${idx}" data-delta="5">+5</button>
      <button class="smallbtn" data-i="${idx}" data-delta="-5">-5</button>
    `;
    // name edit
    row.querySelector("input").addEventListener("change", e=>{
      teams[idx].name = e.target.value.trim() || `Team ${idx+1}`;
      updateCurrentTeamDisplay();
    });
    // score edit
    const scoreCell = row.querySelector(".score");
    scoreCell.addEventListener("input", ()=>{
      const val = parseInt(scoreCell.innerText.replace(/[^\d-]/g,"")) || 0;
      teams[idx].score = val;
    });
    // small buttons
    row.querySelectorAll(".smallbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = +btn.dataset.i;
        const delta = +btn.dataset.delta;
        teams[i].score += delta;
        renderTeams();
      });
    });
    teamsWrap.appendChild(row);
  });
}
function updateCurrentTeamDisplay(){
  // big center name
  currentTeamBig.innerHTML = `<span class="name">${teams[currentTeam].name}</span>`;
  // also update small scoreboard highlights
  document.querySelectorAll(".team").forEach((el,i)=>{
    el.classList.toggle("active", i===currentTeam);
  });
}

/* ------- Timer ------- */
function startTimerMain(){
  isPassTurn = false;
  startTimer(parseInt(timerInput.value,10) || 30);
}
function startTimerPass(){
  isPassTurn = true;
  startTimer(PASS_SECONDS);
}
function startTimer(seconds){
  clearInterval(timerId);
  overlay.hidden = true;
  timerBox.classList.remove("red","orange");
  timeLeft = seconds;
  timeEl.textContent = timeLeft;

  // ensure we initialize timeLeft first, then start ticking (prevents immediate 0)
  timerId = setInterval(()=>{
    timeLeft--;
    timeEl.textContent = timeLeft;

    // urgent beeps and styles
    if (isPassTurn){
      if (timeLeft <= 3 && timeLeft > 0){
        timerBox.classList.add("orange");
        if (timeLeft === 3) playBeep(1200, 0.07, 'sine');
      } else {
        timerBox.classList.remove("orange");
      }
    } else {
      if (timeLeft <= 10 && timeLeft > 0){
        timerBox.classList.add("red");
      }else{
        timerBox.classList.remove("red");
      }
      if (timeLeft <= 3 && timeLeft > 0){
        if (timeLeft === 3) playBeep(1200, 0.07, 'sine');
      }
    }

    if (timeLeft <= 0){
      clearInterval(timerId);
      overlay.hidden = false;
      playBuzzer();

      // If passes remain -> pass automatically
      if (passCount < 3){
        passCount++;
        currentTeam = (currentTeam + 1) % teams.length;
        updateCurrentTeamDisplay();
        setTimeout(()=>{
          overlay.hidden = true;
          playBeep(1000,0.09,'sine');
          startTimerPass();
        }, 700);
      }else{
        // last pass expired
        disableAllOptions();
        showAnswerBtn.disabled = false;
      }
    }
  }, 1000);
}

/* ------- Question flow ------- */
function loadQuestion(){
  if (qIndex >= questions.length){
    qText.textContent = "Quiz Finished — well done!";
    optionsWrap.innerHTML = "";
    showAnswerBtn.disabled = true;
    nextBtn.disabled = true;
    return;
  }

  // starting team rotates per question
  currentTeam = startTeamIndex % teams.length;
  startTeamIndex++;
  passCount = 0;

  questionCompleted = false;
  clickedSet.clear();
  overlay.hidden = true;

  const q = questions[qIndex];
  qText.textContent = q.question;
  qNumEl.textContent = `Q${qIndex+1}`;

  optionsWrap.innerHTML = "";
  q.options.forEach((opt, i)=>{
    const btn = document.createElement("button");
    btn.className = "option";
    btn.dataset.index = i;
    btn.type = "button";

    if (isImageUrl(opt)){
      const url = opt.trim().toLowerCase().startsWith("img:") ? opt.trim().slice(4).trim() : opt.trim();
      const img = document.createElement("img");
      img.src = url;
      img.alt = `Option ${i+1}`;
      btn.appendChild(img);
    }else{
      btn.textContent = opt;
    }

    btn.addEventListener("click", ()=> handleOptionClick(btn, i));
    optionsWrap.appendChild(btn);
  });

  correctIndex = q.answerIndex;

  // controls
  showAnswerBtn.disabled = true;
  nextBtn.disabled = true;

  renderTeams();
  updateCurrentTeamDisplay();
  // Start main timer after a tiny delay so it never reads 0 immediately
  setTimeout(()=> startTimerMain(), 80);
}

function handleOptionClick(btn, i){
  if (questionCompleted) return;

  clickedSet.add(i);
  const isCorrect = (i === correctIndex);

  if (isCorrect){
    btn.classList.add("correct");
    disableAllOptions();
    clearInterval(timerId);
    overlay.hidden = true;
    const award = PASS_POINTS[Math.min(passCount, PASS_POINTS.length-1)];
    teams[currentTeam].score += award;
    renderTeams();
    showAnswerBtn.disabled = false;
    playBeep(1400,0.14,'triangle');
  }else{
    btn.classList.add("wrong");
    btn.disabled = true;
    playBeep(240,0.12,'sine');

    const allDisabled = Array.from(document.querySelectorAll(".option")).every(b=>b.disabled);
    if (allDisabled){
      clearInterval(timerId);
      showAnswerBtn.disabled = false;
      return;
    }

    clearInterval(timerId);
    if (passCount < 3){
      passCount++;
      currentTeam = (currentTeam + 1) % teams.length;
      updateCurrentTeamDisplay();
      setTimeout(()=>{
        playBeep(1000,0.09,'sine');
        startTimerPass();
      }, 300);
    }else{
      disableAllOptions();
      showAnswerBtn.disabled = false;
    }
  }

  if (clickedSet.size >= 4){
    showAnswerBtn.disabled = false;
  }
}

function disableAllOptions(){
  document.querySelectorAll(".option").forEach(b=> b.disabled = true);
}

/* Show correct → then enable Next */
showAnswerBtn.addEventListener("click", ()=>{
  document.querySelectorAll(".option").forEach((b, idx)=>{
    if (idx === correctIndex) b.classList.add("correct");
    b.disabled = true;
  });
  questionCompleted = true;
  nextBtn.disabled = false;
  showAnswerBtn.disabled = true;
});

nextBtn.addEventListener("click", ()=>{
  qIndex++;
  loadQuestion();
});

/* ------- Data load ------- */
async function loadCSV(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = csvToRows(text);
    if (!rows || rows.length < 2) throw new Error("No rows");
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const qi = header.indexOf("question");
    const a1 = header.indexOf("option1");
    const a2 = header.indexOf("option2");
    const a3 = header.indexOf("option3");
    const a4 = header.indexOf("option4");
    const ans = header.indexOf("answer");
    questions = rows.slice(1).filter(r=>r.length && r[qi]).map(r=>{
      const opts = [r[a1], r[a2], r[a3], r[a4]].map(x=> (x||"").trim());
      const answerText = (r[ans]||"").trim();
      let answerIndex = -1;
      const n = parseInt(answerText,10);
      if (!Number.isNaN(n) && n>=1 && n<=4) answerIndex = n-1;
      else answerIndex = opts.findIndex(o=> o === answerText);
      if (answerIndex < 0) answerIndex = 0;
      return { question:r[qi], options:opts, answerIndex };
    });
  }catch(e){
    console.error("CSV load failed", e);
    qText.textContent = "Failed to load questions — check CSV URL.";
  }
}

/* ------- Init ------- */
function init(){
  renderTeams();
  updateCurrentTeamDisplay();
  loadCSV().then(()=>{ loadQuestion(); });

  // Keep timer sane
  timerInput.addEventListener("change", ()=>{
    const v = parseInt(timerInput.value,10);
    if (isNaN(v) || v<5) timerInput.value = 5;
  });

  // ensure audio context resume on user gesture (some browsers block)
  document.addEventListener('click', ()=>{ if (audioCtx.state === 'suspended') audioCtx.resume(); }, { once:true });
}
init();
</script>
</body>
</html>
