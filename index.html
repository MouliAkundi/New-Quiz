<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>College Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ... your full CSS remains unchanged ... */
</style>
</head>
<body>
<!-- Access Code Overlay -->
<div id="accessOverlay">
  <h2>Enter Quiz Code</h2>
  <input type="password" id="quizCodeInput" placeholder="Enter code"/>
  <button id="enterQuizBtn">Enter Quiz</button>
  <p id="errorMsg"></p>
</div>

<!-- Full-screen red flash when time hits 0 -->
<div id="timeout-overlay" class="timeout-overlay" hidden></div>

<!-- Header with your two logos -->
<header class="header">
  <img id="logoLeft" class="logo" alt="Logo 1" />
  <h1 class="brand">College Quiz</h1>
  <img id="logoRight" class="logo" alt="Logo 2" />
</header>

<main class="layout">
  <!-- Quiz panel -->
  <section class="quiz-panel">
    <div class="controls">
      <label class="timer-label">
        Timer (sec):
        <input type="number" id="timerInput" min="5" value="30" />
      </label>
      <div class="timer">Time Left: <span id="time">30</span>s</div>
    </div>

    <div id="currentTeam" class="current-team"></div>

    <!-- Royal blue question band -->
    <div class="question-band">
      <div id="question" class="question-text">Loading question…</div>
    </div>

    <!-- Options -->
    <div id="options" class="options"></div>

    <div class="action-row">
      <button id="showAnswerBtn" class="btn" disabled>Show Correct Answer</button>
      <button id="nextBtn" class="btn primary" disabled>Next Question</button>
    </div>
  </section>

  <!-- Scoreboard -->
  <aside class="scoreboard">
    <h2>Leaderboard</h2>
    <div id="teams"></div>
  </aside>
</main>

<script>
/* ------- ACCESS CODE ------- */
const ACCESS_CODE = "QUIZ2025"; // set your quiz code
const accessOverlay = document.getElementById("accessOverlay");
const enterBtn = document.getElementById("enterQuizBtn");
const codeInput = document.getElementById("quizCodeInput");
const errorMsg = document.getElementById("errorMsg");

enterBtn.addEventListener("click", () => {
  if(codeInput.value.trim() === ACCESS_CODE){
    accessOverlay.style.display = "none"; // hide overlay
  } else {
    errorMsg.textContent = "Incorrect code. Try again!";
    codeInput.value = "";
  }
});

/********** CONFIG **********/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRiqqInQm40Eo-MOFDuPOC40etCZdH3Fxnb5ZrZwJk2ziHeIVGOYyQ0xqWKNsL-vw1FxEfYzr7u18fZ/pub?output=csv";
const LOGO_LEFT  = "https://drive.google.com/uc?export=view&id=1QCjEZ7XRiElI9pBeyCxtfnFLh_xuB4iS";
const LOGO_RIGHT = "https://drive.google.com/uc?export=view&id=1xKpU5akmap9vLgxtVyL0HMX1bsKUQdFl";
const PASS_POINTS = [4,3,2,1];
const PASS_SECONDS = 5;

/* ------- DOM refs ------- */
document.getElementById("logoLeft").src = LOGO_LEFT;
document.getElementById("logoRight").src = LOGO_RIGHT;

const timerInput = document.getElementById("timerInput");
const timeEl = document.getElementById("time");
const timerBox = document.querySelector(".timer");
const overlay = document.getElementById("timeout-overlay");

const currentTeamEl = document.getElementById("currentTeam");
const qText = document.getElementById("question");
const optionsWrap = document.getElementById("options");
const showAnswerBtn = document.getElementById("showAnswerBtn");
const nextBtn = document.getElementById("nextBtn");
const teamsWrap = document.getElementById("teams");

/* ------- State ------- */
let questions = [], qIndex=0;
let teams = [
  { name:"Team A", score:0 },
  { name:"Team B", score:0 },
  { name:"Team C", score:0 },
  { name:"Team D", score:0 },
];
let startTeamIndex = 0, currentTeam = 0, passCount = 0;
let timerId = null, timeLeft = 30, isPassTurn = false;
let clickedSet = new Set(), correctIndex = -1, questionCompleted = false;

/* ------- Utils ------- */
function csvToRows(csvText){
  const rows = []; let row = [], cell = "", inQuotes = false;
  for (let i=0;i<csvText.length;i++){
    const c = csvText[i];
    if(c === '"'){
      if(inQuotes && csvText[i+1]==='"'){ cell+='"'; i++; }
      else inQuotes=!inQuotes;
    }else if(c===',' && !inQuotes){ row.push(cell); cell=""; }
    else if(c==='\n' && !inQuotes){ row.push(cell); rows.push(row); row=[]; cell=""; }
    else{ cell+=c; }
  }
  if(cell.length || row.length){ row.push(cell); rows.push(row); }
  return rows;
}
function isImageUrl(s){
  if(!s) return false;
  const lower = s.trim().toLowerCase();
  if(lower.startsWith("img:")) return true;
  return /^https?:\/\/.+\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(lower);
}

/* ------- Leaderboard ------- */
function renderTeams(){
  teamsWrap.innerHTML = "";
  teams.forEach((t, idx)=>{
    const row = document.createElement("div");
    row.className = "team"+(idx===currentTeam?" active":"");
    row.innerHTML=`
      <input type="text" value="${t.name}" />
      <span class="score" contenteditable="true">${t.score}</span>
      <button class="smallbtn" data-i="${idx}" data-delta="1">+1</button>
      <button class="smallbtn" data-i="${idx}" data-delta="-1">-1</button>
      <button class="smallbtn" data-i="${idx}" data-delta="5">+5</button>
      <button class="smallbtn" data-i="${idx}" data-delta="-5">-5</button>
    `;
    row.querySelector("input").addEventListener("change", e=>{
      teams[idx].name=e.target.value.trim()||`Team ${idx+1}`;
      updateCurrentTeamDisplay();
    });
    const scoreCell = row.querySelector(".score");
    scoreCell.addEventListener("input", ()=>{
      const val=parseInt(scoreCell.innerText.replace(/[^\d-]/g,""))||0;
      teams[idx].score=val;
    });
    row.querySelectorAll(".smallbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i=+btn.dataset.i, delta=+btn.dataset.delta;
        teams[i].score+=delta;
        renderTeams();
      });
    });
    teamsWrap.appendChild(row);
  });
}
function updateCurrentTeamDisplay(){
  currentTeamEl.innerHTML = `Current Team: <span class="name">${teams[currentTeam].name}</span> (Pass ${passCount})`;
  document.querySelectorAll(".team").forEach((el,i)=>{
    el.classList.toggle("active", i===currentTeam);
  });
}

/* ------- Timer ------- */
function startTimerMain(){ isPassTurn=false; startTimer(parseInt(timerInput.value,10)||30);}
function startTimerPass(){ isPassTurn=true; startTimer(PASS_SECONDS);}
function startTimer(seconds){
  clearInterval(timerId); overlay.hidden=true; timerBox.classList.remove("red","orange");
  timeLeft=seconds; timeEl.textContent=timeLeft;
  timerId=setInterval(()=>{
    timeLeft--; timeEl.textContent=timeLeft;
    if(!isPassTurn){
      if(timeLeft<=10 && timeLeft>0) timerBox.classList.add("red");
      else timerBox.classList.remove("red");
    }else{
      if(timeLeft<=3 && timeLeft>0) timerBox.classList.add("orange");
      else timerBox.classList.remove("orange");
    }
    if(timeLeft<=0){
      clearInterval(timerId); overlay.hidden=false;
      handleAutoPassOrEnd();
    }
  },1000);
}

/* ------- FIXED: Pass/Skip handling ------- */
function handleAutoPassOrEnd(){
  if(passCount < 3){
    passCount++;
    currentTeam = (currentTeam + 1) % teams.length;
    updateCurrentTeamDisplay();
    setTimeout(()=>{
      overlay.hidden = true;
      startTimerPass();
    },500);
  } else {
    // All teams skipped → allow moving on
    clearInterval(timerId);
    overlay.hidden = true;
    disableAllOptions();
    questionCompleted = true;
    showAnswerBtn.disabled = false;
    nextBtn.disabled = false;
  }
}

/* ------- Question flow ------- */
function loadQuestion(){
  if(qIndex>=questions.length){
    qText.textContent="Quiz Finished. Great job!";
    optionsWrap.innerHTML="";
    showAnswerBtn.disabled=true;
    nextBtn.disabled=true;
    return;
  }
  currentTeam=startTeamIndex%teams.length; startTeamIndex++;
  passCount=0; questionCompleted=false; clickedSet.clear();
  overlay.hidden=true;

  const q=questions[qIndex];
  qText.textContent=q.question;
  optionsWrap.innerHTML="";
  q.options.forEach((opt,i)=>{
    const btn=document.createElement("button");
    btn.className="option";
    btn.dataset.index=i;
    if(isImageUrl(opt)){
      const url=opt.trim().toLowerCase().startsWith("img:")? opt.trim().slice(4).trim() : opt.trim();
      const img=document.createElement("img");
      img.src=url;
      img.alt=`Option ${i+1}`;
      btn.appendChild(img);
    } else {
      btn.textContent=opt;
    }
    btn.addEventListener("click", ()=> handleOptionClick(btn,i));
    optionsWrap.appendChild(btn);
  });
  correctIndex=q.answerIndex;
  nextBtn.disabled=true; showAnswerBtn.disabled=true;
  updateCurrentTeamDisplay(); startTimerMain();
}

function handleOptionClick(btn,i){
  if(questionCompleted) return;
  clickedSet.add(i);
  const isCorrect=(i===correctIndex);
  if(isCorrect){
    btn.classList.add("correct");
    disableAllOptions();
    clearInterval(timerId);
    overlay.hidden=true;
    const award=PASS_POINTS[Math.min(passCount,PASS_POINTS.length-1)];
    teams[currentTeam].score+=award;
    renderTeams();
    showAnswerBtn.disabled=false;
  } else {
    btn.classList.add("wrong");
    btn.disabled=true;
    const allDisabled=Array.from(document.querySelectorAll(".option")).every(b=>b.disabled);
    if(allDisabled){
      clearInterval(timerId);
      showAnswerBtn.disabled=false;
      return;
    }
    clearInterval(timerId);
    handleAutoPassOrEnd();
  }
}

function disableAllOptions(){
  document.querySelectorAll(".option").forEach(b=>b.disabled=true);
}
showAnswerBtn.addEventListener("click", ()=>{
  document.querySelectorAll(".option").forEach((b,idx)=>{
    if(idx===correctIndex) b.classList.add("correct");
    b.disabled=true;
  });
  questionCompleted=true;
  nextBtn.disabled=false;
  showAnswerBtn.disabled=true;
});
nextBtn.addEventListener("click", ()=>{
  qIndex++;
  loadQuestion();
});

/* ------- Load CSV ------- */
fetch(CSV_URL)
  .then(r=>r.text())
  .then(txt=>{
    const rows=csvToRows(txt);
    questions=rows.slice(1).map(r=>({
      question:r[0],
      options:r.slice(1,5),
      answerIndex:parseInt(r[5],10)
    }));
    renderTeams();
    loadQuestion();
  });
</script>
</body>
</html>
